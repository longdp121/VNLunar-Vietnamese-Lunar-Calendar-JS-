<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VNLunar — Chuyển lịch Dương ↔ Âm</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --bg:#f7fafc;            /* light background */
      --card:#ffffff;          /* cards */
      --ink:#1a202c;           /* text */
      --muted:#4a5568;         /* secondary text */
      --brand:#2563eb;         /* primary accent */
      --brand-weak:#dbeafe;    /* accent bg */
      --ring:#93c5fd;          /* focus ring */
      --ok:#059669;            /* success */
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --radius:16px;
      --radius-sm:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink);
      background:linear-gradient(180deg,#f8fbff 0%, #eef6ff 100%);
    }
    .wrap{
      max-width:960px;
      margin:32px auto;
      padding:0 16px;
    }
    .title{
      text-align:center;
      margin:8px 0 18px;
      font-size:clamp(20px, 3.5vw, 32px);
      font-weight:800;
      letter-spacing:.2px;
    }
    .sub{
      text-align:center;
      color:var(--muted);
      margin-bottom:22px;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    /* Tabs */
    .tabs{
      display:flex;
      gap:8px;
      background:transparent;
      padding:6px;
      border-radius:999px;
      justify-content:center;
      margin:0 auto 16px;
      max-width:min(520px, 95%);
    }
    .tab{
      flex:1;
      text-align:center;
      padding:10px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:14px;
      background:#eff6ff;
      color:#1d4ed8;
      border:1px solid #dbeafe;
      cursor:pointer;
      user-select:none;
      transition:all .15s ease;
      white-space:nowrap;
    }
    .tab:hover{filter:brightness(0.98)}
    .tab.active{
      background:var(--brand);
      color:white;
      border-color:var(--brand);
      box-shadow:0 6px 18px rgba(37,99,235,.35);
    }
    /* Grids */
    .grid{
      display:grid;
      gap:14px;
    }
    @media (min-width: 720px){
      .grid.cols-2{grid-template-columns:1fr 1fr;}
    }
    .section{
      border:1px solid #eef2ff;
      border-radius:var(--radius);
      padding:18px;
      background:white;
    }
    .section h3{
      margin:0 0 10px;
      font-size:16px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{font-weight:600; font-size:13px; color:#334155;}
    input[type="number"],
    input[type="text"],
    input[type="date"],
    select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#fff;
      font-size:15px;
      transition:border-color .15s, box-shadow .15s;
    }
    input:focus, select:focus{
      outline:none;
      border-color:var(--ring);
      box-shadow:0 0 0 4px rgba(147,197,253,.35);
    }
    .center-stack{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      padding:16px;
      text-align:center;
    }
    .date-hero{
      width:min(320px, 100%);
    }
    .muted{color:var(--muted)}
    .result{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:12px 14px;
      border-radius:12px;
      background:var(--brand-weak);
      color:#1e3a8a;
      border:1px solid #bfdbfe;
      word-break:break-word;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:#ecfdf5;
      color:#065f46;
      font-weight:700;
      font-size:12px;
      border:1px solid #d1fae5;
      width:max-content;
    }
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .spacer{height:8px}
    .footer{
      text-align:center;
      margin-top:18px;
      color:var(--muted);
      font-size:13px;
    }
    .tz{
      display:flex; gap:8px; align-items:center; justify-content:center;
      margin:10px 0 6px;
      color:#334155;
      font-size:14px;
    }
    .tz select{
      width:auto; min-width:120px;
      padding:8px 10px; border-radius:12px;
    }
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Chuyển lịch Dương ↔ Âm</h1>
    <p class="sub">Dựa trên bản chuyển đổi Lua trên Wikipedia: <a href="https://vi.wikipedia.org/wiki/M%C3%B4_%C4%91un:%C3%82m_l%E1%BB%8Bch#" target="_blank" rel="noopener">Mô đun:Âm lịch</a></p>

    <div class="card">
      <div class="tabs" role="tablist" aria-label="Chuyển đổi lịch">
        <button class="tab active" id="tab-duong-am" role="tab" aria-selected="true" aria-controls="panel-duong-am">Dương → Âm</button>
        <button class="tab" id="tab-am-duong" role="tab" aria-selected="false" aria-controls="panel-am-duong">Âm → Dương</button>
      </div>

      <!-- Timezone chooser -->
      <div class="tz">
        <span>Múi giờ: </span>
        <select id="tzSelect" title="Chọn múi giờ (giờ lệch UTC)">
          <option value="7" selected>UTC+7 (Việt Nam)</option>
          <option value="8">UTC+8</option>
          <option value="9">UTC+9</option>
          <option value="5.5">UTC+5:30</option>
          <option value="0">UTC±0</option>
          <option value="-5">UTC-5</option>
          <option value="-8">UTC-8</option>
        </select>
      </div>

      <!-- Panels -->
      <div id="panel-duong-am" role="tabpanel" aria-labelledby="tab-duong-am">
        <div class="center-stack">
          <div class="badge">Dương → Âm</div>
          <div class="field date-hero">
            <label for="solarDate">Chọn ngày dương (Gregorian)</label>
            <input type="date" id="solarDate" />
          </div>
          <div class="small muted">Ngày âm hiển thị theo múi giờ đã chọn.</div>
        </div>

        <div class="grid cols-2">
          <div class="section">
            <h3>Kết quả (Âm lịch)</h3>
            <div class="grid">
              <div class="result" id="lunarResultBox">
                <div><strong>Ngày âm:</strong> <span id="lunarPretty">—</span></div>
                <div><strong>Chi tiết:</strong> <span id="lunarDetail">—</span></div>
                <div class="row">
                  <span><strong>Nhuận:</strong> <span id="lunarLeap">—</span></span>
                  <span>•</span>
                  <span><strong>Tháng (số):</strong> <span id="lunarMonthNum">—</span></span>
                </div>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Can Chi</h3>
            <div class="grid">
              <div class="row"><strong>Năm:</strong> <span id="canChiYear" style="margin-left:8px">—</span></div>
              <div class="row"><strong>Tháng:</strong> <span id="canChiMonth" style="margin-left:8px">—</span></div>
              <div class="row"><strong>Ngày:</strong> <span id="canChiDay" style="margin-left:8px">—</span></div>
            </div>
          </div>
        </div>
      </div>

      <div id="panel-am-duong" role="tabpanel" aria-labelledby="tab-am-duong" hidden>
        <div class="center-stack">
          <div class="badge">Âm → Dương</div>
          <div class="field date-hero">
            <label for="solarOut">Ngày dương (kết quả)</label>
            <input type="date" id="solarOut" />
          </div>
          <div class="small muted">Thay đổi mục “Âm lịch đầu vào” sẽ cập nhật ngày dương này.</div>
        </div>

        <div class="grid cols-2">
          <div class="section">
            <h3>Âm lịch đầu vào</h3>
            <div class="grid">
              <div class="row" style="gap:12px">
                <div class="field" style="flex:1; min-width:90px;">
                  <label for="lDay">Ngày</label>
                  <input type="number" id="lDay" min="1" max="30" placeholder="1–30" />
                </div>
                <div class="field" style="flex:1; min-width:110px;">
                  <label for="lMonth">Tháng</label>
                  <select id="lMonth">
                    <option value="" disabled selected>—</option>
                  </select>
                </div>
                <div class="field" style="flex:1; min-width:120px;">
                  <label for="lYear">Năm (dương)</label>
                  <input type="number" id="lYear" placeholder="VD: 2000" />
                </div>
              </div>
              <div class="row">
                <label class="row" style="gap:8px; align-items:center;">
                  <input type="checkbox" id="lLeap" />
                  <span>Tháng nhuận</span>
                </label>
              </div>
              <div class="small muted">Lưu ý: trong mã gốc, tháng âm dùng chỉ số 0..11, trong đó 0 nghĩa là tháng 12. Ở đây ta nhập theo con số quen thuộc 1..12.</div>
            </div>
          </div>

          <div class="section">
            <h3>Kết quả (Dương lịch)</h3>
            <div class="result">
              <div><strong>Chuỗi:</strong> <span id="solarPretty">—</span></div>
              <div><strong>Định dạng:</strong> <span id="solarDetail">—</span></div>
            </div>
          </div>
        </div>
      </div>

      <p class="footer">© 2025 · VNLunar · <a href="https://vi.wikipedia.org/wiki/M%C3%B4_%C4%91un:%C3%82m_l%E1%BB%8Bch#" target="_blank" rel="noopener">Nguồn gốc thuật toán (Lua)</a></p>
    </div>
  </div>

  <!-- Load library first -->
  <script src="vnlunar.js" defer></script>

  <!-- App logic -->
  <script>
    // Wait for DOM
    document.addEventListener('DOMContentLoaded', () => {
      // Grab elements
      const tabDA = document.getElementById('tab-duong-am');
      const tabAD = document.getElementById('tab-am-duong');
      const panelDA = document.getElementById('panel-duong-am');
      const panelAD = document.getElementById('panel-am-duong');
      const tzSelect = document.getElementById('tzSelect');

      // Dương → Âm
      const solarDate = document.getElementById('solarDate');
      const lunarPretty = document.getElementById('lunarPretty');
      const lunarDetail = document.getElementById('lunarDetail');
      const lunarLeap = document.getElementById('lunarLeap');
      const lunarMonthNum = document.getElementById('lunarMonthNum');
      const canChiYear = document.getElementById('canChiYear');
      const canChiMonth = document.getElementById('canChiMonth');
      const canChiDay = document.getElementById('canChiDay');

      // Âm → Dương
      const lDay = document.getElementById('lDay');
      const lMonth = document.getElementById('lMonth');
      const lYear = document.getElementById('lYear');
      const lLeap = document.getElementById('lLeap');
      const solarOut = document.getElementById('solarOut');
      const solarPretty = document.getElementById('solarPretty');
      const solarDetail = document.getElementById('solarDetail');

      // Populate lunar month select 1..12
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement('option');
        opt.value = String(m);
        opt.textContent = `Tháng ${m}`;
        lMonth.appendChild(opt);
      }

      // Tab switching
      function showTab(which){
        const setActive = (btn, on) => {
          btn.classList.toggle('active', on);
          btn.setAttribute('aria-selected', on ? 'true' : 'false');
        };
        if (which === 'DA'){
          setActive(tabDA, true);
          setActive(tabAD, false);
          panelDA.hidden = false;
          panelAD.hidden = true;
        } else {
          setActive(tabDA, false);
          setActive(tabAD, true);
          panelDA.hidden = true;
          panelAD.hidden = false;
        }
      }
      tabDA.addEventListener('click', () => showTab('DA'));
      tabAD.addEventListener('click', () => showTab('AD'));

      // Helpers
      const pad2 = n => String(n).padStart(2,'0');
      const parseDateInput = (el) => {
        if(!el.value) return null;
        const [y,m,d] = el.value.split('-').map(Number);
        return { y, m, d };
      };
      const setDateInput = (el, y, m, d) => {
        el.value = `${y}-${pad2(m)}-${pad2(d)}`;
      };

      // Default: set today
      const today = new Date();
      setDateInput(solarDate, today.getFullYear(), today.getMonth()+1, today.getDate());

      // Dương → Âm conversion
      function updateSolarToLunar(){
        const utc = parseFloat(tzSelect.value);
        const dt = parseDateInput(solarDate);
        if(!dt) return;

        const [dd, mmIdx, yyyy, leapFlag] = VNLunar.Solar2Lunar(dt.d, dt.m, dt.y, utc);
        const monthHuman = (mmIdx === 0) ? 12 : mmIdx;

        lunarPretty.textContent = VNLunar.main(dt.d, dt.m, dt.y, 'full', utc);
        lunarDetail.textContent = `ngày ${dd} tháng ${monthHuman}${leapFlag? ' (nhuận)' : ''} năm ${yyyy}`;
        lunarLeap.textContent = leapFlag ? 'Có' : 'Không';
        lunarMonthNum.textContent = monthHuman;

        // Can Chi
        const canNam = VNLunar.canchi(yyyy + 57);
        const canThang = VNLunar.canchi(yyyy * 12 + monthHuman + 14);
        const canNgay = VNLunar.canchi(VNLunar.toInt(VNLunar.LocalToJD(dt.d, dt.m, dt.y, utc) + 51.5));
        canChiYear.textContent = canNam;
        canChiMonth.textContent = canThang;
        canChiDay.textContent = canNgay;
      }

      // Âm → Dương conversion
      function updateLunarToSolar(){
        const utc = parseFloat(tzSelect.value);
        const d = parseInt(lDay.value, 10);
        const m = parseInt(lMonth.value, 10);
        const y = parseInt(lYear.value, 10);
        const leap = lLeap.checked ? 1 : 0;

        if(!(d>0) || !(m>=1 && m<=12) || !(y)){
          solarPretty.textContent = '—';
          solarDetail.textContent = '—';
          return;
        }

        // In Lua mapping, month 12 is 0
        const luaMonth = (m === 12) ? 0 : m;
        // Use DF formats per implementation
        const pretty = VNLunar.Lunar2Solar(d, luaMonth, y, utc, 'full', leap);
        const dmy = VNLunar.Lunar2Solar(d, luaMonth, y, utc, 'd-m-y', leap);

        solarPretty.textContent = pretty || '—';
        solarDetail.textContent = dmy || '—';

        // Try to set the date picker from d-m-y if available
        if (dmy && /^\d{2}-\d{2}-\d{4}$/.test(dmy)){
          const [dd, mm, yyyy] = dmy.split('-').map(Number);
          setDateInput(solarOut, yyyy, mm, dd);
        } else {
          solarOut.value = '';
        }
      }

      // Events
      tzSelect.addEventListener('change', () => {
        updateSolarToLunar();
        updateLunarToSolar();
      });
      solarDate.addEventListener('change', updateSolarToLunar);

      [lDay, lMonth, lYear, lLeap].forEach(el => {
        el.addEventListener('input', updateLunarToSolar);
        el.addEventListener('change', updateLunarToSolar);
      });

      // Initialize defaults
      // Prefill lunar inputs using today (for convenience)
      (() => {
        const utc = parseFloat(tzSelect.value);
        const [dd, mmIdx, yyyy] = VNLunar.Solar2Lunar(today.getDate(), today.getMonth()+1, today.getFullYear(), utc);
        lDay.value = dd;
        lMonth.value = (mmIdx === 0) ? '12' : String(mmIdx);
        lYear.value = yyyy;
      })();

      updateSolarToLunar();
      updateLunarToSolar();
    });
  </script>

</body>
</html>
